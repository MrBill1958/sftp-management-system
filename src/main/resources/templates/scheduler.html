<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFTP Manager - Task Scheduler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/editor/editor.main.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .navbar-brand, .navbar-nav .nav-link {
            color: white !important;
        }
        .main-container {
            margin-top: 80px;
        }
        .task-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        .task-status {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .task-enabled { color: #28a745; }
        .task-disabled { color: #dc3545; }

        .schedule-badge {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-right: 5px;
        }
        .code-editor {
            height: 400px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .execution-log {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: monospace;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-size: 0.9rem;
        }
        .log-success { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-warning { color: #ffcc00; }

        .day-selector {
            display: flex;
            gap: 5px;
        }
        .day-selector label {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }
        .day-selector input[type="checkbox"] {
            display: none;
        }
        .day-selector input[type="checkbox"]:checked + label {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <i class="bi bi-shield-lock"></i> SFTP Manager
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">
                        <i class="bi bi-house"></i> Sites
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/file-manager">
                        <i class="bi bi-folder"></i> File Manager
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/scheduler">
                        <i class="bi bi-clock"></i> Scheduler
                    </a>
                </li>
                <li class="nav-item admin-only d-none">
                    <a class="nav-link" href="/admin">
                        <i class="bi bi-gear"></i> Admin
                    </a>
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i> <span id="currentUser">User</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid main-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Task Scheduler</h2>
        <button class="btn btn-primary" onclick="showAddTaskModal()">
            <i class="bi bi-plus-circle"></i> Create New Task
        </button>
    </div>

    <div id="tasksContainer">
        <!-- Tasks will be loaded here -->
    </div>

    <div class="mt-5">
        <h4>Execution History</h4>
        <div class="execution-log" id="executionLog">
            <div class="log-entry">[System] Task scheduler initialized</div>
        </div>
    </div>
</div>

<!-- Add/Edit Task Modal -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalTitle">Create New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="taskName" class="form-label">Task Name</label>
                                <input type="text" class="form-control" id="taskName" required>
                            </div>
                            <div class="mb-3">
                                <label for="taskSite" class="form-label">SFTP Site</label>
                                <select class="form-select" id="taskSite" required>
                                    <option value="">Select a site...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Days of Week</label>
                                <div class="day-selector">
                                    <input type="checkbox" id="mon" value="MON">
                                    <label for="mon">Mon</label>
                                    <input type="checkbox" id="tue" value="TUE">
                                    <label for="tue">Tue</label>
                                    <input type="checkbox" id="wed" value="WED">
                                    <label for="wed">Wed</label>
                                    <input type="checkbox" id="thu" value="THU">
                                    <label for="thu">Thu</label>
                                    <input type="checkbox" id="fri" value="FRI">
                                    <label for="fri">Fri</label>
                                    <input type="checkbox" id="sat" value="SAT">
                                    <label for="sat">Sat</label>
                                    <input type="checkbox" id="sun" value="SUN">
                                    <label for="sun">Sun</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="executionTime" class="form-label">Execution Time</label>
                                <input type="time" class="form-control" id="executionTime" required>
                            </div>
                            <div class="mb-3">
                                <label for="commandLineParams" class="form-label">Command Line Parameters</label>
                                <input type="text" class="form-control" id="commandLineParams"
                                       placeholder="key1=value1 key2=value2">
                                <small class="text-muted">Space-separated key=value pairs</small>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="taskEnabled" checked>
                                <label class="form-check-label" for="taskEnabled">
                                    Task Enabled
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Jython Script</label>
                            <div id="codeEditor" class="code-editor"></div>
                            <small class="text-muted mt-2 d-block">
                                Available variables: site_name, site_host, site_port, site_username, site_password, site_path
                            </small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="testTask()">Test Script</button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">Save Task</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/loader.js"></script>
<script>
    let tasks = [];
    let editor = null;
    let editingTaskId = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        checkAuth();
        loadSites();
        loadTasks();
        initializeEditor();
    });

    function checkAuth() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        document.getElementById('currentUser').textContent = localStorage.getItem('username');

        const roles = JSON.parse(localStorage.getItem('roles') || '[]');
        if (roles.some(role => role.roleName === 'ROLE_ADMIN')) {
            document.querySelectorAll('.admin-only').forEach(el => {
                el.classList.remove('d-none');
            });
        }
    }

    function initializeEditor() {
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('codeEditor'), {
                value: `# Jython script for SFTP automation
# Available variables: site_name, site_host, site_port, site_username, site_password, site_path

from com.jcraft.jsch import JSch, Session, ChannelSftp
import java.util.Properties as Properties

def connect_sftp():
    """Connect to SFTP server"""
    jsch = JSch()
    session = jsch.getSession(site_username, site_host, site_port)
    session.setPassword(site_password)
    
    config = Properties()
    config.put("StrictHostKeyChecking", "no")
    session.setConfig(config)
    
    session.connect()
    channel = session.openChannel("sftp")
    channel.connect()
    
    return session, channel

# Main execution
try:
    session, sftp = connect_sftp()
    
    # Your automation logic here
    # Example: List files in the target path
    sftp.cd(site_path)
    files = sftp.ls(".")
    
    print(f"Connected to {site_name} at {site_host}")
    print(f"Files in {site_path}:")
    for entry in files:
        print(f"  - {entry.getFilename()}")
    
    # Set result for the task
    result = "Task completed successfully"
    
finally:
    if 'sftp' in locals():
        sftp.disconnect()
    if 'session' in locals():
        session.disconnect()
`,
                language: 'python',
                theme: 'vs-dark',
                minimap: { enabled: false },
                automaticLayout: true
            });
        });
    }

    async function loadSites() {
        try {
            const response = await fetch('/api/sites', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            });

            if (response.ok) {
                const sites = await response.json();
                const selector = document.getElementById('taskSite');

                sites.forEach(site => {
                    const option = document.createElement('option');
                    option.value = site.id;
                    option.textContent = site.siteName;
                    selector.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading sites:', error);
        }
    }

    async function loadTasks() {
        try {
            const response = await fetch('/api/scheduler/tasks', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            });

            if (response.ok) {
                tasks = await response.json();
                renderTasks();
                addLog('Loaded ' + tasks.length + ' scheduled tasks', 'success');
            }
        } catch (error) {
            console.error('Error loading tasks:', error);
            addLog('Error loading tasks: ' + error.message, 'error');
        }
    }

    function renderTasks() {
        const container = document.getElementById('tasksContainer');

        if (tasks.length === 0) {
            container.innerHTML = `
                    <div class="alert alert-info">
                        No scheduled tasks configured. Click "Create New Task" to add one.
                    </div>
                `;
            return;
        }

        container.innerHTML = tasks.map(task => `
                <div class="task-card">
                    <div class="task-status">
                        <i class="bi ${task.enabled ? 'bi-check-circle-fill task-enabled' : 'bi-x-circle-fill task-disabled'}"></i>
                    </div>
                    <h5>${task.taskName}</h5>
                    <p class="text-muted mb-2">Site: ${task.site.siteName}</p>
                    <div class="mb-2">
                        ${task.daysOfWeek.split(',').map(day => `<span class="schedule-badge">${day}</span>`).join('')}
                        <span class="schedule-badge"><i class="bi bi-clock"></i> ${task.executionTime}</span>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">
                            Last execution: ${task.lastExecution ? new Date(task.lastExecution).toLocaleString() : 'Never'}<br>
                            Status: ${task.lastExecutionStatus || 'Not executed'}
                        </small>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-primary" onclick="editTask(${task.id})">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-info" onclick="executeTask(${task.id})">
                            <i class="bi bi-play"></i> Run Now
                        </button>
                        <button class="btn btn-sm ${task.enabled ? 'btn-warning' : 'btn-success'}" 
                                onclick="toggleTask(${task.id}, ${!task.enabled})">
                            <i class="bi ${task.enabled ? 'bi-pause' : 'bi-play'}"></i> 
                            ${task.enabled ? 'Disable' : 'Enable'}
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTask(${task.id})">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
    }

    function showAddTaskModal() {
        editingTaskId = null;
        document.getElementById('taskModalTitle').textContent = 'Create New Task';
        document.getElementById('taskForm').reset();

        // Clear day selections
        document.querySelectorAll('.day-selector input').forEach(cb => cb.checked = false);

        // Reset editor
        if (editor) {
            editor.setValue(`# Jython script for SFTP automation
# Available variables: site_name, site_host, site_port, site_username, site_password, site_path

from com.jcraft.jsch import JSch, Session, ChannelSftp
import java.util.Properties as Properties

def connect_sftp():
    """Connect to SFTP server"""
    jsch = JSch()
    session = jsch.getSession(site_username, site_host, site_port)
    session.setPassword(site_password)
    
    config = Properties()
    config.put("StrictHostKeyChecking", "no")
    session.setConfig(config)
    
    session.connect()
    channel = session.openChannel("sftp")
    channel.connect()
    
    return session, channel

# Main execution
try:
    session, sftp = connect_sftp()
    
    # Your automation logic here
    # Example: List files in the target path
    sftp.cd(site_path)
    files = sftp.ls(".")
    
    print(f"Connected to {site_name} at {site_host}")
    print(f"Files in {site_path}:")
    for entry in files:
        print(f"  - {entry.getFilename()}")
    
    # Set result for the task
    result = "Task completed successfully"
    
finally:
    if 'sftp' in locals():
        sftp.disconnect()
    if 'session' in locals():
        session.disconnect()
`);
        }

        new bootstrap.Modal(document.getElementById('taskModal')).show();
    }

    function editTask(id) {
        const task = tasks.find(t => t.id === id);
        if (!task) return;

        editingTaskId = id;
        document.getElementById('taskModalTitle').textContent = 'Edit Task';

        document.getElementById('taskName').value = task.taskName;
        document.getElementById('taskSite').value = task.site.id;
        document.getElementById('executionTime').value = task.executionTime;
        document.getElementById('commandLineParams').value = task.commandLineParams || '';
        document.getElementById('taskEnabled').checked = task.enabled;

        // Set days
        const days = task.daysOfWeek.split(',');
        document.querySelectorAll('.day-selector input').forEach(cb => {
            cb.checked = days.includes(cb.value);
        });

        // Set script
        if (editor) {
            editor.setValue(task.jythonScript);
        }

        new bootstrap.Modal(document.getElementById('taskModal')).show();
    }

    async function saveTask() {
        const selectedDays = Array.from(document.querySelectorAll('.day-selector input:checked'))
            .map(cb => cb.value);

        if (selectedDays.length === 0) {
            alert('Please select at least one day');
            return;
        }

        const taskData = {
            taskName: document.getElementById('taskName').value,
            siteId: document.getElementById('taskSite').value,
            daysOfWeek: selectedDays.join(','),
            executionTime: document.getElementById('executionTime').value,
            commandLineParams: document.getElementById('commandLineParams').value,
            jythonScript: editor.getValue(),
            enabled: document.getElementById('taskEnabled').checked
        };

        try {
            const url = editingTaskId ? `/api/scheduler/tasks/${editingTaskId}` : '/api/scheduler/tasks';
            const method = editingTaskId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                },
                body: JSON.stringify(taskData)
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                loadTasks();
                addLog(`Task ${editingTaskId ? 'updated' : 'created'} successfully`, 'success');
            }
        } catch (error) {
            console.error('Error saving task:', error);
            addLog('Error saving task: ' + error.message, 'error');
        }
    }

    async function executeTask(id) {
        addLog(`Executing task ID ${id}...`, 'info');

        try {
            const response = await fetch(`/api/scheduler/tasks/${id}/execute`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            });

            if (response.ok) {
                const result = await response.json();
                addLog(`Task executed: ${result.message}`, result.success ? 'success' : 'error');
                loadTasks();
            }
        } catch (error) {
            addLog('Error executing task: ' + error.message, 'error');
        }
    }

    async function toggleTask(id, enable) {
        try {
            const response = await fetch(`/api/scheduler/tasks/${id}/toggle?enable=${enable}`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            });

            if (response.ok) {
                loadTasks();
                addLog(`Task ${enable ? 'enabled' : 'disabled'}`, 'success');
            }
        } catch (error) {
            addLog('Error toggling task: ' + error.message, 'error');
        }
    }

    async function deleteTask(id) {
        if (!confirm('Are you sure you want to delete this task?')) return;

        try {
            const response = await fetch(`/api/scheduler/tasks/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            });

            if (response.ok) {
                loadTasks();
                addLog('Task deleted successfully', 'success');
            }
        } catch (error) {
            addLog('Error deleting task: ' + error.message, 'error');
        }
    }

    function testTask() {
        alert('Test functionality would execute the script with the selected site credentials');
        // In a real implementation, this would send the script to the server for testing
    }

    function addLog(message, type = 'info') {
        const log = document.getElementById('executionLog');
        const timestamp = new Date().toLocaleTimeString();
        const typeClass = type === 'success' ? 'log-success' :
            type === 'error' ? 'log-error' :
                type === 'warning' ? 'log-warning' : '';

        const entry = document.createElement('div');
        entry.className = `log-entry ${typeClass}`;
        entry.textContent = `[${timestamp}] ${message}`;

        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }

    function logout() {
        localStorage.clear();
        window.location.href = '/login';
    }
</script>
</body>
</html>